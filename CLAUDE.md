# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

DigitalHome.Cloud Modeler — a Gatsby 5 / React 18 web app providing a 3D interactive ontology viewer and component library for the DHC core ontology (`dhc-core.schema.ttl`). Visualizes ~48 classes and ~64 properties across 8 design views as a force-directed 3D graph. Includes a Library module for managing reusable SmartHome components. Admin/dev tool in the DigitalHome.Cloud ecosystem.

## Commands

- `yarn develop` — Start local dev server (localhost:8002)
- `yarn build` — Production build (outputs to `public/`)
- `yarn clean` — Clear Gatsby cache (`.cache/` and `public/`)
- `yarn format` — Prettier formatting across all source files
- `yarn parse-ontology` — Regenerate `src/data/ontology-graph.json` from the TTL schema
- `yarn publish-ontology` — Upload ontology artifacts to S3 (`public/ontology/v{VERSION}/`)
- `yarn generate-blockly-toolbox` — Generate Blockly block definitions and toolbox config from TTL
- No test suite is configured yet

## Architecture

### 3D Ontology Viewer

The viewer uses a 3-panel layout:

```
┌──────────┬─────────────────────────┬──────────┐
│ Sidebar  │     3D Graph Canvas     │ Inspector│
│ (240px)  │      (flex: 1)          │ (280px)  │
└──────────┴─────────────────────────┴──────────┘
```

- `src/components/WorkspaceShell.js` — 3-panel layout, manages selected node and active view filter state
- `src/components/OntologyGraph.js` — SSR-safe 3D force graph (react-force-graph-3d via dynamic import)
- `src/components/OntologySidebar.js` — Left panel with collapsible design view sections, ontology version badge
- `src/components/OntologyInspector.js` — Right panel showing selected node details
- `src/data/ontology-graph.json` — Pre-parsed graph data with `meta`, `nodes`, `links` (generated, committed)

### Library Module

- `src/pages/library.js` — Library page listing all LibraryItems
- `src/components/LibraryList.js` — Table with auth-gated admin actions (create/edit/delete)
- `src/components/LibraryForm.js` — Create/edit form with ontology class multi-select
- `src/graphql/queries.js`, `src/graphql/mutations.js` — Auto-generated by `amplify pull` (do not hand-edit)

Library data is stored in DynamoDB via AppSync (GraphQL). The `LibraryItem` type is defined in the portal's Amplify backend schema. Each library item includes capability flags (`hasActorCapability`, `hasSensorCapability`, `hasControllerCapability`). Editing requires `dhc-admins` Cognito group; reading requires any authenticated user.

### Blockly Toolbox Generator

The modeler generates Blockly block definitions from the T-Box ontology:

- `scripts/generate-blockly-toolbox.js` — Parses `dhc-core.schema.ttl` and generates block definition and toolbox JSON
- `scripts/blockly-overrides.json` — Hand-maintained overrides (dropdown values, defaults, view cross-listings)
- `src/data/blockly-blocks.json` — Generated block definitions (committed)
- `src/data/blockly-toolbox.json` — Generated toolbox configuration (committed)

The toolbox is published to S3 alongside the ontology (`public/ontology/vX.Y.Z/blockly-blocks.json` and `blockly-toolbox.json`). The Designer fetches these at runtime.

### Authentication

`AuthContext` (`src/context/AuthContext.js`) wraps the app via `gatsby-browser.js` / `gatsby-ssr.js`. Same pattern as the portal — SSR-safe, uses `getCurrentUser()` + `fetchAuthSession()` from Amplify JS v6.

- `authState`: `"loading"` | `"demo"` | `"authenticated"`
- `user`, `groups`, `hasGroup(name)`, `signOut()`, `reloadSession()`
- Sign-in page at `/signin/` uses `@aws-amplify/ui-react` `<Authenticator>`
- SSO via shared Cognito pool: portal login carries over to modeler

Config: `src/aws-exports.deployment.js` (env-var-driven, safe to commit). Local dev values in `.env.development` (gitignored).

### Ontology Source & Lifecycle

The ontology lives inside this repo under `semantic-core/`:

```
semantic-core/
  ontology/
    dhc-core.schema.ttl    ← core ontology (classes, properties, design views)
    context.jsonld          ← JSON-LD context for runtime use
  modules/
    module-manifest.json   ← module discovery config (id, file, category, countries)
    dhc-nfc14100-electrical.ttl  ← NF C 14-100 energy delivery module (FR)
    dhc-nfc15100-electrical.ttl  ← NF C 15-100 installation module (FR)
  instances/
    DE-DEMO.ttl             ← demo instance data
    FR-DEMO-01.ttl          ← French demo with NFC 14-100 delivery chain
  shapes/                   ← SHACL validation shapes
```

**Key principle:** Ontology changes are always **deployments**, not runtime edits. The TTL defines the foundational vocabulary — changing it affects all apps and instance data, so it follows a versioned release process.

**Flow:**
1. **Author** — TTL files are edited and versioned in this repo under `semantic-core/` (semantic versioning: `model-vX.Y.Z`)
2. **Build-time parse** — `scripts/parse-ontology.js` reads the Core TTL + module TTLs (via `module-manifest.json`) and generates `src/data/ontology-graph.json` (includes `meta.version`, `meta.label`, `meta.modules`)
3. **Generate toolbox** — `scripts/generate-blockly-toolbox.js` reads Core + modules, generates Blockly block definitions with subclass property inheritance and module defaults
4. **Publish** — `scripts/publish-ontology.js` uploads artifacts + module files to S3 at `public/ontology/v{VERSION}/` and `public/ontology/latest/`
4. **Deploy** — Amplify Hosting deploys the modeler with the freshly parsed graph data baked in

### Design Views

Nodes are color-coded by `dhc:designView` annotation:
- Spatial (green #22c55e), Building (amber #f59e0b), Electrical (blue #3b82f6)
- Plumbing (cyan #06b6d4), Heating (red #ef4444), Network (purple #a855f7)
- Governance (orange #f97316), Automation (pink #ec4899), Shared/none (white #e5e7eb)

### Navigation

Header links: Modeler (home), Library, Portal (cross-app).
- `GATSBY_PORTAL_URL` → defaults to `https://portal.digitalhome.cloud`
- User pill shows DEMO badge or authenticated user name
- Language switcher: EN / DE / FR

### Internationalization

Three languages: `en` (default), `de`, `fr`. Translation files in `src/locales/<lang>/common.json`. Uses `gatsby-plugin-react-i18next`.

### Styling

Plain CSS in `src/styles/global.css`. Dark-mode theme with slate/blue palette. No CSS framework.

## Files That Must Never Be Committed

- `amplify/` — Entire directory (created by `amplify pull`, contains `team-provider-info.json` with AWS account IDs and ARNs)
- `src/aws-exports.js` — Amplify-generated config with hardcoded values
- `.env.development` — Local env vars with actual endpoint URLs and IDs
- `.graphqlconfig.yml` — Generated by Amplify, references local paths

All of these are listed in `.gitignore`. The modeler is a **frontend-only consumer** — the portal repo owns the Amplify backend.

## Dependencies & Licenses

All dependencies are open source. Key libraries:

| Package | License | Notes |
|---------|---------|-------|
| react, react-dom | MIT | UI framework |
| gatsby | MIT | Static site generator |
| aws-amplify | Apache-2.0 | AWS Amplify JS SDK v6 |
| @aws-amplify/ui-react | Apache-2.0 | Pre-built auth UI components |
| react-force-graph-3d | MIT | 3D force-directed graph |
| three | MIT | WebGL 3D engine |
| @aws-sdk/client-s3 | Apache-2.0 | S3 upload (devDependency) |
| i18next, react-i18next | MIT | Internationalization |

No copyleft (GPL/LGPL/AGPL) dependencies.

## Multi-Repo Ecosystem

| App | Repo | Port | URL |
|-----|------|------|-----|
| Portal | `digitalhome-cloud-portal` | 8000 | `portal.digitalhome.cloud` |
| Designer | `digitalhome-cloud-designer` | 8001 | `designer.digitalhome.cloud` |
| Modeler | `digitalhome-cloud-modeler` | 8002 | `modeler.digitalhome.cloud` |

The portal owns the Amplify Gen1 backend. The semantic-core ontology files live inside the modeler repo under `semantic-core/`.

All repos use `stage` branch for staging work before merging to `main`.

## Access Model

The modeler is an **expert and admin tool** — it visualizes the core ontology, which is general domain knowledge (not tenant-specific). No SmartHome ID is required.

| Mode | Who | Capabilities |
|------|-----|--------------|
| **DEMO** | Anyone (no login) | Full read-only 3D graph, browse all design views, inspect node details |
| **Authenticated** | Any signed-in user | Browse Library items |
| **Admin** | `dhc-admins` Cognito group | Create/edit/delete Library items |

## Deployment

Amplify Hosting with branch-to-environment mapping:
- `main` → production (`modeler.digitalhome.cloud`)
- `stage` → staging

Build spec is in `amplify.yml`. The build runs `npm run parse-ontology && npm run build` and deploys `public/`.
